<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maintenance • Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    html { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900" x-data>
  <div class="min-h-dvh">
    <header class="border-b bg-white/50 backdrop-blur supports-[backdrop-filter]:bg-white/70 sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
        <h1 class="text-xl sm:text-2xl font-semibold tracking-tight">Tableau de bord Maintenance & Interventions</h1>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">
      <section class="bg-white rounded-xl shadow-sm ring-1 ring-slate-200 p-4 sm:p-6">
        <form class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 items-end" th:action="@{/dashboard}" method="get">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Priorité</label>
            <select name="priority" class="w-full rounded-lg border-slate-300 focus:border-indigo-500 focus:ring-indigo-500" th:value="${selectedPriority}">
              <option value="">Toutes</option>
              <option th:each="p : ${priorities}" th:value="${p}" th:text="${p}"></option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Statut</label>
            <select name="status" class="w-full rounded-lg border-slate-300 focus:border-indigo-500 focus:ring-indigo-500" th:value="${selectedStatus}">
              <option value="">Tous</option>
              <option th:each="s : ${statuses}" th:value="${s}" th:text="${s}"></option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Technicien</label>
            <select name="technicianId" class="w-full rounded-lg border-slate-300 focus:border-indigo-500 focus:ring-indigo-500" th:value="${selectedTechnicianId}">
              <option value="">Tous</option>
              <option th:each="t : ${technicians}" th:value="${t.id}" th:text="${t.nom}"></option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Site</label>
            <select name="site" class="w-full rounded-lg border-slate-300 focus:border-indigo-500 focus:ring-indigo-500" th:value="${selectedSite}">
              <option value="">Tous</option>
              <option th:each="site : ${sites}" th:value="${site}" th:text="${site}"></option>
            </select>
          </div>
          <div class="flex gap-3">
            <button type="submit" class="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2.5 text-white font-medium hover:bg-indigo-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500">
              Filtrer
            </button>
            <a th:href="@{/dashboard}" class="inline-flex items-center justify-center rounded-lg bg-slate-100 px-4 py-2.5 text-slate-700 font-medium hover:bg-slate-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-400">Réinitialiser</a>
          </div>
        </form>
      </section>

      <section class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <a th:href="@{/equipements}" class="block bg-white rounded-xl shadow-sm ring-1 ring-slate-200 p-4 sm:p-6 hover:shadow">
          <div class="text-sm text-slate-500">Gestion</div>
          <div class="mt-2 text-lg font-semibold">Équipements →</div>
        </a>
        <a th:href="@{/techniciens}" class="block bg-white rounded-xl shadow-sm ring-1 ring-slate-200 p-4 sm:p-6 hover:shadow">
          <div class="text-sm text-slate-500">Gestion</div>
          <div class="mt-2 text-lg font-semibold">Techniciens →</div>
        </a>
        <a th:href="@{/interventions}" class="block bg-white rounded-xl shadow-sm ring-1 ring-slate-200 p-4 sm:p-6 hover:shadow">
          <div class="text-sm text-slate-500">Gestion</div>
          <div class="mt-2 text-lg font-semibold">Interventions →</div>
        </a>
      </section>

      <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white rounded-xl shadow-sm ring-1 ring-slate-200 p-4 sm:p-6">
          <div class="text-sm text-slate-500">MTTR (heures)</div>
          <div class="mt-2 text-3xl font-semibold" th:text="${mttr}">0.0</div>
        </div>
        <div class="bg-white rounded-xl shadow-sm ring-1 ring-slate-200 p-4 sm:p-6">
          <div class="text-sm text-slate-500">Incidents ce mois</div>
          <div class="mt-2 text-3xl font-semibold" th:text="${currentMonthIncidents}">0</div>
        </div>
        <div class="bg-white rounded-xl shadow-sm ring-1 ring-slate-200 p-4 sm:p-6">
          <div class="text-sm text-slate-500">Incidents ouverts</div>
          <div class="mt-2 text-3xl font-semibold" th:text="${openIncidents}">0</div>
        </div>
      </section>

      <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="bg-white rounded-xl shadow-sm ring-1 ring-slate-200 p-4 sm:p-6">
          <div class="flex items-center justify-between">
            <h2 class="text-base font-semibold">MTTR par mois</h2>
          </div>
          <div class="mt-4">
            <canvas id="mttrChart" width="400" height="240"
                    th:attr="data-labels=${chartLabels},data-values=${mttrPerMonth}"></canvas>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm ring-1 ring-slate-200 p-4 sm:p-6">
          <div class="flex items-center justify-between">
            <h2 class="text-base font-semibold">Incidents par mois</h2>
          </div>
          <div class="mt-4">
            <canvas id="incidentsChart" width="400" height="240"
                    th:attr="data-labels=${chartLabels},data-values=${incidentsPerMonth}"></canvas>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-xl shadow-sm ring-1 ring-slate-200">
        <div class="p-4 sm:p-6 border-b">
          <h2 class="text-base font-semibold">Interventions</h2>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-200">
            <thead class="bg-slate-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ID</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Équipement</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Priorité</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Statut</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Technicien</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Site</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Créée</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Résolue</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-slate-200" th:remove="all-but-first">
              <tr th:each="itv : ${interventions}">
                <td class="px-4 py-3 text-sm text-slate-700" th:text="${itv.equipement.id}">-</td>
                <td class="px-4 py-3 text-sm text-slate-700" th:text="${itv.equipement.code}">-</td>
                <td class="px-4 py-3 text-sm">
                  <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium"
                        th:classappend="${itv.priorite}=='HAUTE' ? 'bg-red-100 text-red-700' : (${itv.priorite}=='MOYENNE' ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700')"
                        th:text="${itv.priorite}"></span>
                </td>
                <td class="px-4 py-3 text-sm">
                  <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium"
                        th:text="${itv.statut}"
                        th:classappend="${itv.statut}=='OUVERT' ? 'bg-blue-100 text-blue-700' : (${itv.statut}=='EN_COURS' ? 'bg-amber-100 text-amber-700' : 'bg-slate-200 text-slate-700')"></span>
                </td>
                <td class="px-4 py-3 text-sm text-slate-700" th:text="${itv.technicien!=null? itv.technicien.nom : '—'}">—</td>
                <td class="px-4 py-3 text-sm text-slate-700" th:text="${itv.equipement!=null? itv.equipement.site : '—'}">—</td>
                <td class="px-4 py-3 text-sm text-slate-500" th:text="${#temporals.format(itv.dateOuverture, 'dd/MM/yyyy')}">-</td>
                <td class="px-4 py-3 text-sm text-slate-500" th:text="${itv.dateCloture!=null? #temporals.format(itv.dateCloture, 'dd/MM/yyyy') : '—'}">—</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script>
    function parseDataset(el) {
      const labels = el.getAttribute('data-labels');
      const values = el.getAttribute('data-values');
      try {
        return {
          labels: labels ? JSON.parse(labels) : [],
          values: values ? JSON.parse(values) : []
        };
      } catch (e) { return { labels: [], values: [] }; }
    }

    const mttrEl = document.getElementById('mttrChart');
    if (mttrEl) {
      const d = parseDataset(mttrEl);
      new Chart(mttrEl, {
        type: 'line',
        data: {
          labels: d.labels,
          datasets: [{
            label: 'Heures',
            data: d.values,
            borderColor: '#4f46e5',
            backgroundColor: 'rgba(79,70,229,0.15)',
            fill: true,
            tension: 0.35,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { display: false } }
        }
      });
    }

    const incEl = document.getElementById('incidentsChart');
    if (incEl) {
      const d = parseDataset(incEl);
      new Chart(incEl, {
        type: 'bar',
        data: {
          labels: d.labels,
          datasets: [{
            label: 'Incidents',
            data: d.values,
            backgroundColor: '#06b6d4'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { display: false } }
        }
      });
    }
  </script>
</body>
</html>
